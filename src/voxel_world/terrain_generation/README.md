# 地形生成システム

このディレクトリには、Furaxel の地形生成ロジックが含まれています。このシステムは、非同期、マルチステージ、そして拡張可能な設計になっています。

## アーキテクチャ

地形生成パイプラインは Bevy Plugin (`TerrainGenerationPlugin`) として実装されており、主に3つのステージで構成されています：

1.  **高度マップとバイオームマップの生成**
2.  **ベース地形の生成**
3.  **フィーチャー（特徴物）の生成**

これらのステージは各チャンクに対して順番に実行されますが、Bevy の `AsyncComputeTaskPool` を使用して異なるチャンク間で並列に実行されます。

### 1. 高度マップとバイオームマップの生成 (`ComputingAltitude`)

*   **入力**: チャンク座標 (XZ), シード値。
*   **処理**:
    *   Perlin ノイズ (FBM, RidgedMulti, Billow) を組み合わせて、高度用の2Dノイズマップを生成します。
    *   気温と湿度のノイズマップに基づいてバイオームを決定します。
*   **出力**: `AltitudeMap` (`Vec<i32>`) および `BiomeMap` (`Vec<u8>`)。
*   **保存**: 結果は `TerrainGenerationStorage` に `Arc<[T]>` としてキャッシュされ、スレッド間で低コストで共有されます。

### 2. ベース地形の生成 (`ComputingBaseTerrain`)

*   **入力**: 高度マップ, バイオームマップ, チャンク位置 (XYZ)。
*   **処理**:
    *   チャンク内のボクセルを反復処理します。
    *   高度マップに基づいてブロックを配置します：
        *   `altitude - 3` より下: `STONE` (石)
        *   地表のすぐ下: `Biome::sub_surface_block` (例: 土)
        *   地表: `Biome::surface_block` (例: 草ブロック)
        *   海面 (y=0) より下で空の場合: `WATER` (水)
*   **出力**: `TerrainChunkData` (ボクセルデータ)。
*   **アクション**: チャンクデータを `ChunkMap` に挿入します。

### 3. フィーチャー（特徴物）の生成 (`ComputingFeatures`)

*   **入力**: 高度マップ, 隣接チャンクの状態。
*   **依存関係**: **全8方向の隣接チャンク** (3x3 エリア) のベース地形生成が完了している必要があります。これにより、チャンク境界をまたぐフィーチャー（木など）を正しく配置できるようになります（現在はローカル生成に簡略化されていますが、将来的には重要になります）。
*   **処理**:
    *   チャンクの地表を反復処理します。
    *   バイオームごとのフィーチャー生成確率をチェックします。
    *   `BiomeRegistry` で定義されたフィーチャー（例: 木）を配置します。
*   **出力**: ボクセル変更のリスト (`Vec<(IVec3, Voxel)>`)。
*   **アクション**: `set_bulk` を使用して `ChunkMap` に変更を適用します。

## ファイル構成

*   `mod.rs`: プラグイン定義、ECS システム、非同期タスク管理。フローと調整を担当します。
*   `generation.rs`: コアとなる生成ロジック（ノイズ、ブロック配置ルール）を含む純粋関数群。
*   `biomes.rs`: `Biome`、`BiomeRegistry` の定義、およびバイオーム固有のパラメータ。
*   `feature.rs`: フィーチャー（例: `TreeFeature`）の定義とその配置ロジック。
*   `storage.rs`: 生成データをキャッシュするためのリソース定義 (`TerrainGenerationStorage`)。

## 新しいバイオームやフィーチャーの追加

1.  **フィーチャーの定義**: `feature.rs` で `Feature` トレイトを実装します。
2.  **バイオームの登録**: `biomes.rs` の `BiomeRegistry::new` に新しい `Biome` エントリを追加し、フィーチャーを紐付けます。
3.  **ノイズの調整**: 必要に応じて `generation.rs` のノイズパラメータを調整し、バイオームの分布を制御します。
